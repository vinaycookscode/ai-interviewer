generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  EMPLOYER
  CANDIDATE
  ADMIN
}

enum InterviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  geminiApiKey  String?   // User provided API key
  role          Role      @default(CANDIDATE)
  
  // Location tracking
  country       String?
  countryCode   String?
  city          String?
  latitude      Float?
  longitude     Float?
  ipAddress     String?
  
  // Candidate Profile
  resumeUrl     String?
  resumeName    String?
  features      Json?     // Feature flags for this user (e.g. { "multilingual": true })
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Core Relations
  accounts      Account[]
  sessions      Session[]
  jobs          Job[]       @relation("EmployerJobs")
  interviews    Interview[]
  mockInterviews MockInterview[]
  
  // Placement Platform Relations
  programEnrollments ProgramEnrollment[]
  squadMemberships   SquadMember[]
  mentorProfile      MentorProfile?
  mentorships        Mentorship[]  @relation("MenteeRelation")
  jobOffers          JobOffer[]
  companySolutions   UserCompanySolution[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

model Job {
  id          String @id @default(uuid())
  title       String
  description String
  employerId  String
  employer    User   @relation("EmployerJobs", fields: [employerId], references: [id])

  // Document requirements
  requireResume Boolean @default(false)
  requireAadhar Boolean @default(false)
  requirePAN    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions  Question[]
  interviews Interview[]
}

enum QuestionType {
  TEXT
  CODE
}

model Question {
  id        String       @id @default(uuid())
  text      String
  type      QuestionType @default(TEXT)
  jobId     String
  job       Job          @relation(fields: [jobId], references: [id])
  createdAt DateTime     @default(now())
  archived  Boolean      @default(false)

  answers Answer[]
}

model Interview {
  id          String          @id @default(uuid())
  candidateId String
  candidate   User            @relation(fields: [candidateId], references: [id])
  jobId       String
  job         Job             @relation(fields: [jobId], references: [id])
  status      InterviewStatus @default(PENDING)
  token       String?         @unique // For secure access

  // Scheduling
  scheduledTime DateTime? // When the interview is scheduled
  expiresAt     DateTime? // When the interview link expires

  // Document uploads
  resumeUrl         String?
  aadharUrl         String?
  panUrl            String?
  documentsVerified Boolean @default(false)

  // Results
  score     Float? // Overall score
  feedback  String? // Overall feedback
  language  String   @default("en") // Interview language (en, hi, mr, etc.)
  createdAt DateTime @default(now())

  answers Answer[]
  personalityProfile PersonalityProfile?
  proctoringEvents ProctoringEvent[]
}

model Answer {
  id          String    @id @default(uuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id])
  questionId  String
  question    Question  @relation(fields: [questionId], references: [id])
  transcript  String // The text of the answer
  audioUrl    String? // Optional: link to audio file
  videoUrl    String? // Optional: link to video file
  score       Float? // Score for this specific answer
  feedback    String? // Feedback for this specific answer
  createdAt   DateTime  @default(now())
}

model DailyStat {
  id        String   @id @default(uuid())
  date      DateTime @unique
  visitors  Int      @default(0)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VisitorLocation {
  id          String   @id @default(uuid())
  country     String
  countryCode String
  city        String?
  latitude    Float?
  longitude   Float?
  visits      Int      @default(1)
  lastVisit   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([countryCode])
}

model MockInterview {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Practice settings
  role        String   // e.g., "Frontend Developer"
  difficulty  String   // "Junior", "Mid", "Senior"
  
  // Results
  score       Float?
  feedback    String?
  
  createdAt   DateTime @default(now())
  
  answers     MockAnswer[]
}

model MockAnswer {
  id              String        @id @default(uuid())
  mockInterviewId String
  mockInterview   MockInterview @relation(fields: [mockInterviewId], references: [id])
  
  question        String        // Store question text directly as it's dynamic
  transcript      String
  audioUrl        String?
  score           Float?
  feedback        String?
  
  createdAt       DateTime      @default(now())
}

model PersonalityProfile {
  id                 String    @id @default(uuid())
  interviewId        String    @unique
  interview          Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  // Core Traits
  communicationStyle String    // e.g., "Concise", "Elaborate", "Technical"
  confidenceScore    Float     // 0-10
  technicalDepth     String    // "Surface", "Intermediate", "Expert"
  
  // Detailed Analysis
  strengths          String[]
  weaknesses         String[]
  cultureFitScore    Float     // 0-100
  
  summary            String    @db.Text
  
  createdAt          DateTime  @default(now())
}

model RateLimit {
  id          String   @id @default(uuid())
  identifier  String   // IP address or email
  count       Int      @default(0)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@unique([identifier])
}

model ProctoringEvent {
  id          String   @id @default(uuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id])
  type        String   // "TAB_SWITCH", "WINDOW_BLUR", "FULLSCREEN_EXIT"
  timestamp   DateTime @default(now())
  details     String?  // Optional context
}

model FeatureFlag {
  key         String   @id
  enabled     Boolean  @default(true)
  description String?
  category    String   // "CANDIDATE", "EMPLOYER", "SYSTEM"
  updatedAt   DateTime @updatedAt
}

// ============================================
// CAMPUS PLACEMENT SUCCESS PLATFORM
// ============================================

// --- Placement Program ---
enum TaskType {
  PROBLEM
  VIDEO
  QUIZ
  READING
  MOCK_INTERVIEW
  APTITUDE
  HR_PREP
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DROPPED
}

model PlacementProgram {
  id           String   @id @default(cuid())
  name         String   // "90-Day Placement Bootcamp"
  slug         String   @unique
  description  String   @db.Text
  durationDays Int      @default(90)
  isActive     Boolean  @default(true)
  
  modules      ProgramModule[]
  enrollments  ProgramEnrollment[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ProgramModule {
  id          String   @id @default(cuid())
  programId   String
  program     PlacementProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  dayNumber   Int      // Day 1, 2, 3...
  title       String
  description String?
  content     Json?    // Educational content for the day (concept, takeaways, etc.)
  
  tasks       DailyTask[]
  
  @@unique([programId, dayNumber])
}

model DailyTask {
  id          String   @id @default(cuid())
  moduleId    String
  module      ProgramModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title       String
  type        TaskType
  content     Json     // Flexible content based on type
  duration    Int      // Expected minutes
  order       Int      // Task order within day
  
  completions TaskCompletion[]
}

model ProgramEnrollment {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  programId     String
  program       PlacementProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  startDate     DateTime @default(now())
  currentDay    Int      @default(1)
  status        EnrollmentStatus @default(ACTIVE)
  
  streak        Int      @default(0)
  longestStreak Int      @default(0)
  lastActiveAt  DateTime @default(now())
  
  completions   TaskCompletion[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, programId])
}

model TaskCompletion {
  id           String   @id @default(cuid())
  enrollmentId String
  enrollment   ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  taskId       String
  task         DailyTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  startedAt    DateTime @default(now())
  completedAt  DateTime?  // null if started but not completed
  score        Float?   // For quizzes/problems
  timeSpent    Int?     // Actual minutes
  metadata     Json?    // Store user answers (e.g. { code: "...", answers: [...] })
  
  @@unique([enrollmentId, taskId])
}

// --- Company Prep Kits ---
model CompanyPrepKit {
  id          String   @id @default(cuid())
  company     String   @unique // "TCS", "Amazon", "Google"
  slug        String   @unique
  logo        String?
  description String   @db.Text
  
  // Interview Process
  rounds      Json     // [{name, type, duration, tips}]
  salaryRange Json?    // {min, max, currency}
  difficulty  String   @default("MEDIUM") // Overall difficulty
  
  // Deep Concepts & Interview Tips
  content     Json?    // {overview, culture, interviewTips, preparationStrategy}
  
  // Content
  questions   CompanyQuestion[]
  resources   CompanyResource[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CompanyQuestion {
  id          String   @id @default(cuid())
  kitId       String
  kit         CompanyPrepKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  
  question    String   @db.Text      // Problem title
  description String?  @db.Text      // Detailed problem statement with examples and constraints
  type        String   // "CODING", "APTITUDE", "HR", "GD"
  difficulty  String   // "EASY", "MEDIUM", "HARD"
  frequency   Float    @default(5) // How often asked (1-10)
  year        Int?     // Year reported
  
  answer      String?  @db.Text
  tips        String?
  tags        String[] // Topic tags
  
  // Code Editor Support (for CODING type)
  starterCode   String?  @db.Text  // Initial code template
  solutionCode  String?  @db.Text  // Reference solution
  testCases     Json?              // [{input, expected, hidden}]
  language      String?            // javascript, python, java, cpp
  
  createdAt   DateTime @default(now())
  
  userSolutions UserCompanySolution[]
}

model CompanyResource {
  id          String   @id @default(cuid())
  kitId       String
  kit         CompanyPrepKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  
  title       String
  type        String   // "VIDEO", "ARTICLE", "PDF"
  url         String
  
  createdAt   DateTime @default(now())
}

model UserCompanySolution {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId  String
  question    CompanyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  code        String   @db.Text  // User's solution code
  language    String              // Programming language (javascript, python, java, cpp)
  passedTests Int      @default(0)  // Number of tests that passed
  totalTests  Int      @default(0)  // Total number of tests
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, questionId, language])
  @@index([userId])
  @@index([questionId])
}

// --- Study Squad ---
model StudySquad {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  maxMembers      Int      @default(5)
  isPublic        Boolean  @default(false)
  
  // Target
  targetCompanies String[]
  targetRole      String?
  
  members         SquadMember[]
  activities      SquadActivity[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SquadMember {
  id             String   @id @default(cuid())
  squadId        String
  squad          StudySquad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role           String   @default("MEMBER") // "LEADER", "MEMBER"
  joinedAt       DateTime @default(now())
  
  // Stats
  problemsSolved Int      @default(0)
  daysActive     Int      @default(0)
  totalPoints    Int      @default(0)
  
  @@unique([squadId, userId])
}

model SquadActivity {
  id          String   @id @default(cuid())
  squadId     String
  squad       StudySquad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId      String
  
  type        String   // "PROBLEM_SOLVED", "TASK_COMPLETED", "CHECK_IN"
  description String
  points      Int      @default(0)
  
  createdAt   DateTime @default(now())
}

// --- Mentor Matching ---
model MentorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  company     String   // Current company
  role        String   // Current role
  experience  Int      // Years of experience
  college     String?  // Alma mater
  gradYear    Int?     // Graduation year
  
  bio         String?  @db.Text
  linkedin    String?
  
  // Availability
  isAvailable Boolean  @default(true)
  maxMentees  Int      @default(3)
  
  // Expertise
  skills      String[]
  companies   String[] // Companies they can mentor for
  
  mentorships Mentorship[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Mentorship {
  id          String   @id @default(cuid())
  mentorId    String
  mentor      MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  menteeId    String
  mentee      User     @relation("MenteeRelation", fields: [menteeId], references: [id], onDelete: Cascade)
  
  status      String   @default("PENDING") // "PENDING", "ACTIVE", "COMPLETED", "REJECTED"
  startDate   DateTime?
  endDate     DateTime?
  
  // Sessions
  sessions    MentorSession[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([mentorId, menteeId])
}

model MentorSession {
  id           String   @id @default(cuid())
  mentorshipId String
  mentorship   Mentorship @relation(fields: [mentorshipId], references: [id], onDelete: Cascade)
  
  scheduledAt  DateTime
  duration     Int      @default(30) // minutes
  topic        String?
  notes        String?  @db.Text
  completed    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
}

// --- Job Offers ---
model JobOffer {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  company     String
  role        String
  location    String
  
  // Compensation
  baseSalary  Float
  bonus       Float?
  stocks      Float?
  otherBenefits Json?  // {insurance, wfh, etc}
  
  // Details
  joiningDate DateTime?
  offerDate   DateTime @default(now())
  deadline    DateTime?
  
  // Documents
  offerLetterUrl String?  // Uploaded offer letter PDF
  
  status      String   @default("PENDING") // "PENDING", "ACCEPTED", "REJECTED", "NEGOTIATING"
  
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- User Feedback ---
model Feedback {
  id          String   @id @default(cuid())
  userId      String?
  userEmail   String?
  userName    String?
  
  content     String   @db.Text
  page        String?  // URL/route where feedback was submitted
  category    String   @default("GENERAL") // GENERAL, BUG, FEATURE, IMPROVEMENT
  
  status      String   @default("NEW") // NEW, REVIEWED, RESOLVED, DISMISSED
  adminNotes  String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

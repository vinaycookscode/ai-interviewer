generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  EMPLOYER
  CANDIDATE
  ADMIN
}

enum InterviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ============================================
// SUBSCRIPTION SYSTEM ENUMS
// ============================================

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  TRIALING
}

enum PlanTier {
  FREE
  PRO
  PREMIUM
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  geminiApiKey  String?   // User provided API key
  role          Role      @default(CANDIDATE)
  
  // Location tracking
  country       String?
  countryCode   String?
  city          String?
  latitude      Float?
  longitude     Float?
  ipAddress     String?
  
  // Candidate Identity Documents
  resumeUrl     String?
  resumeName    String?
  panUrl        String?
  panName       String?
  aadhaarUrl    String?
  aadhaarName   String?
  
  features      Json?     // Feature flags for this user (e.g. { "multilingual": true })
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Core Relations
  accounts      Account[]
  sessions      Session[]
  jobs          Job[]       @relation("EmployerJobs")
  interviews    Interview[]
  mockInterviews MockInterview[]
  
  // Placement Platform Relations
  candidateProfile CandidateProfile?
  programEnrollments ProgramEnrollment[]
  squadMemberships   SquadMember[]
  mentorProfile      MentorProfile?
  mentorships        Mentorship[]  @relation("MenteeRelation")
  jobOffers          JobOffer[]
  companySolutions   UserCompanySolution[]
  
  // Subscription
  subscription       Subscription?
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

model Job {
  id          String @id @default(uuid())
  title       String
  description String
  employerId  String
  employer    User   @relation("EmployerJobs", fields: [employerId], references: [id])

  // Document requirements
  requireResume Boolean @default(false)
  requireAadhar Boolean @default(false)
  requirePAN    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions  Question[]
  interviews Interview[]

  @@index([employerId])
}

enum QuestionType {
  TEXT
  CODE
}

model Question {
  id        String       @id @default(uuid())
  text      String
  type      QuestionType @default(TEXT)
  jobId     String
  job       Job          @relation(fields: [jobId], references: [id])
  createdAt DateTime     @default(now())
  archived  Boolean      @default(false)

  answers Answer[]
}

model Interview {
  id          String          @id @default(uuid())
  candidateId String
  candidate   User            @relation(fields: [candidateId], references: [id])
  jobId       String
  job         Job             @relation(fields: [jobId], references: [id])
  status      InterviewStatus @default(PENDING)
  token       String?         @unique // For secure access

  // Scheduling
  scheduledTime DateTime? // When the interview is scheduled
  expiresAt     DateTime? // When the interview link expires

  // Document uploads
  resumeUrl         String?
  aadhaarUrl        String?
  panUrl            String?
  documentsVerified Boolean @default(false)

  // Results
  score     Float? // Overall score
  feedback  String? // Overall feedback
  language  String   @default("en") // Interview language (en, hi, mr, etc.)
  createdAt DateTime @default(now())

  answers Answer[]
  personalityProfile PersonalityProfile?
  proctoringEvents ProctoringEvent[]

  @@index([candidateId])
  @@index([jobId])
  @@index([scheduledTime])
  @@index([status])
}

model Answer {
  id          String    @id @default(uuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id])
  questionId  String
  question    Question  @relation(fields: [questionId], references: [id])
  transcript  String // The text of the answer
  audioUrl    String? // Optional: link to audio file
  videoUrl    String? // Optional: link to video file
  score       Float? // Score for this specific answer
  feedback    String? // Feedback for this specific answer
  createdAt   DateTime  @default(now())
}

model DailyStat {
  id        String   @id @default(uuid())
  date      DateTime @unique
  visitors  Int      @default(0)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VisitorLocation {
  id          String   @id @default(uuid())
  country     String
  countryCode String
  city        String?
  latitude    Float?
  longitude   Float?
  visits      Int      @default(1)
  lastVisit   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([countryCode])
}

model MockInterview {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Practice settings
  role        String   // e.g., "Frontend Developer"
  difficulty  String   // "Junior", "Mid", "Senior"
  
  // Results
  score       Float?
  feedback    String?
  
  createdAt   DateTime @default(now())
  
  answers     MockAnswer[]
}

model MockAnswer {
  id              String        @id @default(uuid())
  mockInterviewId String
  mockInterview   MockInterview @relation(fields: [mockInterviewId], references: [id])
  
  question        String        // Store question text directly as it's dynamic
  transcript      String
  audioUrl        String?
  score           Float?
  feedback        String?
  
  createdAt       DateTime      @default(now())
}

model PersonalityProfile {
  id                 String    @id @default(uuid())
  interviewId        String    @unique
  interview          Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  // Core Traits
  communicationStyle String    // e.g., "Concise", "Elaborate", "Technical"
  confidenceScore    Float     // 0-10
  technicalDepth     String    // "Surface", "Intermediate", "Expert"
  
  // Detailed Analysis
  strengths          String[]
  weaknesses         String[]
  cultureFitScore    Float     // 0-100
  
  summary            String    @db.Text
  
  createdAt          DateTime  @default(now())
}

model RateLimit {
  id          String   @id @default(uuid())
  identifier  String   // IP address or email
  count       Int      @default(0)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@unique([identifier])
}

model ProctoringEvent {
  id          String   @id @default(uuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id])
  type        String   // "TAB_SWITCH", "WINDOW_BLUR", "FULLSCREEN_EXIT"
  timestamp   DateTime @default(now())
  details     String?  // Optional context
}

model FeatureFlag {
  key         String   @id
  enabled     Boolean  @default(true)
  description String?
  category    String   // "CANDIDATE", "EMPLOYER", "SYSTEM"
  updatedAt   DateTime @updatedAt
}

// ============================================
// CAMPUS PLACEMENT SUCCESS PLATFORM
// ============================================

// --- Placement Program ---
enum TaskType {
  PROBLEM
  VIDEO
  QUIZ
  READING
  MOCK_INTERVIEW
  APTITUDE
  HR_PREP
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DROPPED
}

model PlacementProgram {
  id           String   @id @default(cuid())
  name         String   // "90-Day Placement Bootcamp"
  slug         String   @unique
  description  String   @db.Text
  durationDays Int      @default(90)
  isActive     Boolean  @default(true)
  
  modules      ProgramModule[]
  enrollments  ProgramEnrollment[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ProgramModule {
  id          String   @id @default(cuid())
  programId   String
  program     PlacementProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  dayNumber   Int      // Day 1, 2, 3...
  title       String
  description String?
  content     Json?    // Educational content for the day (concept, takeaways, etc.)
  
  tasks       DailyTask[]
  
  @@unique([programId, dayNumber])
}

model DailyTask {
  id          String   @id @default(cuid())
  moduleId    String
  module      ProgramModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title       String
  type        TaskType
  content     Json     // Flexible content based on type
  duration    Int      // Expected minutes
  order       Int      // Task order within day
  
  // Personalization
  role        String?  // e.g. "Software Developer", "QA" (null = common)
  skills      String[]
  
  completions TaskCompletion[]
}

model ProgramEnrollment {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  programId     String
  program       PlacementProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  startDate     DateTime @default(now())
  currentDay    Int      @default(1)
  status        EnrollmentStatus @default(ACTIVE)
  
  streak        Int      @default(0)
  longestStreak Int      @default(0)
  lastActiveAt  DateTime @default(now())
  
  completions   TaskCompletion[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, programId])
}

model TaskCompletion {
  id           String   @id @default(cuid())
  enrollmentId String
  enrollment   ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  taskId       String
  task         DailyTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  startedAt    DateTime @default(now())
  completedAt  DateTime?  // null if started but not completed
  score        Float?   // For quizzes/problems
  timeSpent    Int?     // Actual minutes
  metadata     Json?    // Store user answers (e.g. { code: "...", answers: [...] })
  
  @@unique([enrollmentId, taskId])
}

// --- Company Prep Kits ---
model CompanyPrepKit {
  id          String   @id @default(cuid())
  company     String   @unique // "TCS", "Amazon", "Google"
  slug        String   @unique
  logo        String?
  description String   @db.Text
  
  // Interview Process
  rounds      Json     // [{name, type, duration, tips}]
  salaryRange Json?    // {min, max, currency}
  difficulty  String   @default("MEDIUM") // Overall difficulty
  
  // Deep Concepts & Interview Tips
  content     Json?    // {overview, culture, interviewTips, preparationStrategy}
  
  // Content
  questions   CompanyQuestion[]
  resources   CompanyResource[]
  
  // Personalization
  roles       String[] // e.g. ["Software Developer", "QA"]
  skills      String[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CompanyQuestion {
  id          String   @id @default(cuid())
  kitId       String
  kit         CompanyPrepKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  
  question    String   @db.Text      // Problem title
  description String?  @db.Text      // Detailed problem statement with examples and constraints
  type        String   // "CODING", "APTITUDE", "HR", "GD"
  difficulty  String   // "EASY", "MEDIUM", "HARD"
  frequency   Float    @default(5) // How often asked (1-10)
  year        Int?     // Year reported
  
  answer      String?  @db.Text
  tips        String?
  tags        String[] // Topic tags
  roles       String[] // e.g. ["Software Developer", "QA"]
  
  // Code Editor Support (for CODING type)
  starterCode   String?  @db.Text  // Initial code template
  solutionCode  String?  @db.Text  // Reference solution
  testCases     Json?              // [{input, expected, hidden}]
  language      String?            // javascript, python, java, cpp
  
  createdAt   DateTime @default(now())
  
  userSolutions UserCompanySolution[]
}

model CompanyResource {
  id          String   @id @default(cuid())
  kitId       String
  kit         CompanyPrepKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  
  title       String
  type        String   // "VIDEO", "ARTICLE", "PDF"
  url         String
  
  createdAt   DateTime @default(now())
}

model UserCompanySolution {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId  String
  question    CompanyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  code        String   @db.Text  // User's solution code
  language    String              // Programming language (javascript, python, java, cpp)
  passedTests Int      @default(0)  // Number of tests that passed
  totalTests  Int      @default(0)  // Total number of tests
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, questionId, language])
  @@index([userId])
  @@index([questionId])
}

// --- Study Squad ---
model StudySquad {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  maxMembers      Int      @default(5)
  isPublic        Boolean  @default(false)
  
  // Target
  targetCompanies String[]
  targetRole      String?
  
  members         SquadMember[]
  activities      SquadActivity[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SquadMember {
  id             String   @id @default(cuid())
  squadId        String
  squad          StudySquad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role           String   @default("MEMBER") // "LEADER", "MEMBER"
  joinedAt       DateTime @default(now())
  
  // Stats
  problemsSolved Int      @default(0)
  daysActive     Int      @default(0)
  totalPoints    Int      @default(0)
  
  @@unique([squadId, userId])
}

model SquadActivity {
  id          String   @id @default(cuid())
  squadId     String
  squad       StudySquad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId      String
  
  type        String   // "PROBLEM_SOLVED", "TASK_COMPLETED", "CHECK_IN"
  description String
  points      Int      @default(0)
  
  createdAt   DateTime @default(now())
}

// --- Mentor Matching ---
model MentorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  company     String   // Current company
  role        String   // Current role
  experience  Int      // Years of experience
  college     String?  // Alma mater
  gradYear    Int?     // Graduation year
  
  bio         String?  @db.Text
  linkedin    String?
  
  // Availability
  isAvailable Boolean  @default(true)
  maxMentees  Int      @default(3)
  
  // Expertise
  skills      String[]
  companies   String[] // Companies they can mentor for
  
  mentorships Mentorship[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Mentorship {
  id          String   @id @default(cuid())
  mentorId    String
  mentor      MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  menteeId    String
  mentee      User     @relation("MenteeRelation", fields: [menteeId], references: [id], onDelete: Cascade)
  
  status      String   @default("PENDING") // "PENDING", "ACTIVE", "COMPLETED", "REJECTED"
  startDate   DateTime?
  endDate     DateTime?
  
  // Sessions
  sessions    MentorSession[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([mentorId, menteeId])
}

model MentorSession {
  id           String   @id @default(cuid())
  mentorshipId String
  mentorship   Mentorship @relation(fields: [mentorshipId], references: [id], onDelete: Cascade)
  
  scheduledAt  DateTime
  duration     Int      @default(30) // minutes
  topic        String?
  notes        String?  @db.Text
  completed    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
}

// --- Job Offers ---
model JobOffer {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  company     String
  role        String
  location    String
  
  // Compensation
  baseSalary  Float
  bonus       Float?
  stocks      Float?
  otherBenefits Json?  // {insurance, wfh, etc}
  
  // Details
  joiningDate DateTime?
  offerDate   DateTime @default(now())
  deadline    DateTime?
  
  // Documents
  offerLetterUrl String?  // Uploaded offer letter PDF
  
  status      String   @default("PENDING") // "PENDING", "ACCEPTED", "REJECTED", "NEGOTIATING"
  
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- User Feedback ---
model Feedback {
  id          String   @id @default(cuid())
  userId      String?
  userEmail   String?
  userName    String?
  
  content     String   @db.Text
  page        String?  // URL/route where feedback was submitted
  category    String   @default("GENERAL") // GENERAL, BUG, FEATURE, IMPROVEMENT
  
  status      String   @default("NEW") // NEW, REVIEWED, RESOLVED, DISMISSED
  adminNotes  String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// FLASHCARDS SYSTEM
// ============================================

model FlashcardDeck {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // DSA, System Design, Behavioral, SQL, Custom
  isPublic    Boolean  @default(false)
  userId      String?  // null = system deck
  
  cards       Flashcard[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Flashcard {
  id       String   @id @default(cuid())
  deckId   String
  front    String   @db.Text
  back     String   @db.Text
  
  deck     FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  progress FlashcardProgress[]
  
  createdAt DateTime @default(now())
}

model FlashcardProgress {
  id         String   @id @default(cuid())
  userId     String
  cardId     String
  
  box        Int      @default(1)  // Leitner box 1-5
  nextReview DateTime @default(now())
  lastReview DateTime?
  correctCount Int    @default(0)
  incorrectCount Int  @default(0)
  
  card       Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([userId, cardId])
  @@index([userId])
  @@index([nextReview])
}

model CandidateProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  primaryRole     String?  // e.g., "Fullstack Developer", "Automation Tester"
  experienceLevel String?  // e.g., "Student", "Fresh Graduate", "Junior (1-2y)", "Senior (3y+)"
  skills          String[]
  targetCompanies String[]
  careerGoals     String?  @db.Text
  
  onboardingComplete Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SUBSCRIPTION SYSTEM
// ============================================

model SubscriptionPlan {
  id              String        @id @default(cuid())
  name            String        // "Free", "Pro", "Premium"
  tier            PlanTier      @unique
  
  // Pricing in paise (â‚¹249 = 24900 paise)
  monthlyPrice    Int           @default(0)
  yearlyPrice     Int           @default(0)
  
  // Feature limits (-1 = unlimited)
  mockInterviewLimit      Int   @default(2)
  resumeAnalysisLimit     Int   @default(1)
  questionGenerationLimit Int   @default(5)
  coverLetterLimit        Int   @default(0)
  resumeRewriteLimit      Int   @default(0)
  aiEvaluationEnabled     Boolean @default(false)
  prioritySupport         Boolean @default(false)
  
  // Razorpay Plan IDs
  razorpayMonthlyPlanId   String?
  razorpayYearlyPlanId    String?
  
  subscriptions   Subscription[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String             @unique
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId                String
  plan                  SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  status                SubscriptionStatus @default(ACTIVE)
  billingPeriod         BillingPeriod      @default(MONTHLY)
  
  // Razorpay subscription details
  razorpaySubscriptionId String?           @unique
  razorpayCustomerId     String?
  
  // Billing dates
  currentPeriodStart    DateTime           @default(now())
  currentPeriodEnd      DateTime
  cancelledAt           DateTime?
  
  // Payment history
  payments              Payment[]
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  @@index([planId])
}

model Payment {
  id                    String       @id @default(cuid())
  subscriptionId        String
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  amount                Int          // Amount in paise
  currency              String       @default("INR")
  status                String       // "captured", "failed", "refunded"
  
  razorpayPaymentId     String?      @unique
  razorpayOrderId       String?
  razorpaySignature     String?
  
  createdAt             DateTime     @default(now())
  
  @@index([subscriptionId])
}

model UsageRecord {
  id              String   @id @default(cuid())
  userId          String
  
  // Usage type
  featureType     String   // "mock_interview", "resume_analysis", "question_generation", "cover_letter", "resume_rewrite"
  
  // Period tracking
  periodStart     DateTime
  periodEnd       DateTime
  usageCount      Int      @default(1)
  
  createdAt       DateTime @default(now())
  
  @@unique([userId, featureType, periodStart])
  @@index([userId, featureType])
}
